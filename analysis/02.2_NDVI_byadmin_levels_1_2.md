---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.14.5
  kernelspec:
    display_name: hamenv
    language: python
    name: python3
---

# Converting NDVI Values to Admin 1 and Admin 2

```python
%load_ext jupyter_black
import os
from pathlib import Path
import numpy as np
import pandas as pd
import geopandas as gpd
import rasterio
from rasterstats import zonal_stats
import math
```

```python
data_dir = Path(os.getenv("HAM_DIR")) / "vegetation/ndvi/"
eviirs_dir = Path(os.getenv("HAM_DIR")) / "vegetation/ndvi/eviirs/"
emodis_dir = Path(os.getenv("HAM_DIR")) / "vegetation/ndvi/emodis"
output_dir = Path(os.getenv("HAM_DIR")) / "vegetation/"
shp_dir = Path(os.getenv("AA_DATA_DIR")) / "public/raw/ner/cod_ab/ner_cod_ab/"
shp_dir_clp = Path(os.getenv("HAM_DIR")) / "clipped_codab/"
```

```python
ner_shp_adm0 = gpd.read_file(shp_dir / "adm0.shp.zip")
ner_shp_adm1 = gpd.read_file(shp_dir / "adm1.shp.zip")
ner_shp_adm2 = gpd.read_file(shp_dir / "adm2.shp.zip")
```

```python
# clipped adm1 and adm2
ner_shp_adm0_clipped = gpd.read_file(shp_dir_clp / "ner_codab_adm0_clipped_17N.gpkg")
ner_shp_adm1_clipped = gpd.read_file(shp_dir_clp / "ner_codab_adm1_clipped_17N.gpkg")
ner_shp_adm2_clipped = gpd.read_file(shp_dir_clp / "ner_codab_adm2_clipped_17N.gpkg")
```

```python
ner_shp_adm0.total_bounds
```

```python
ner_shp_adm0_clipped.total_bounds
```

Note: NDVI = (value - 100) / 100

```python
eviirs_file_list = [file for file in os.listdir(eviirs_dir) if file.endswith(".tif")]
emodis_file_list = [file for file in os.listdir(emodis_dir) if file.endswith(".tif")]
```

```python
def aggregating_admin(file_list, geodf, admID1, admID2, type, data_dir):
    adm_ndvi_df = pd.DataFrame()
    for file in file_list:
        file_path = Path(data_dir / file)
        input_raster = rasterio.open(file_path)
        array = input_raster.read(1)
        array = np.where(array > 200, 255, array)
        ndvi_array = (array - 100) / 100
        summary_stats = zonal_stats(
            geodf,
            ndvi_array,
            stats=["mean", "median"],
            nodata=1.55,
            all_touched=True,
            affine=input_raster.transform,
        )
        adm_stats = pd.DataFrame(summary_stats)
        file_df = pd.merge(
            geodf[[admID1, admID2]],
            adm_stats,
            left_index=True,
            right_index=True,
        )
        time_period = file[(file.find("wa") + 2) : file.find(".tif")]
        file_df["month"] = (
            "20" + time_period[0:2] + "-" + f"{math.ceil(int(time_period[2:4]) / 6):02}"
        )
        if type == "eviirs":
            file_df["pentad"] = time_period[2:4]
        else:
            file_df["dekad"] = time_period[2:4]
        adm_ndvi_df = pd.concat([adm_ndvi_df, file_df], axis=0)
    return adm_ndvi_df
```

## Admin 0

```python
ner_shp_adm0.drop(
    ["OBJECTID", "Shape_Leng", "Shape_Area", "ISO2"], axis=1, inplace=True
)
```

```python
adm0_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_shp_adm0,
    admID1="ISO3",
    admID2="NOMPAY",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm0_ndvi_df.to_csv(output_dir / "ner_adm0_ndvi_eviirs.csv", index=False)
```

```python
adm0_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_shp_adm0_clipped,
    admID1="ISO3",
    admID2="NOMPAY",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm0_ndvi_df.to_csv(output_dir / "ner_adm0_clipped_ndvi_eviirs.csv", index=False)
```

```python
adm0_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_shp_adm0,
    admID1="ISO3",
    admID2="NOMPAY",
    type="emodis",
    data_dir=emodis_dir,
)
adm0_ndvi_df.to_csv(output_dir / "ner_adm0_ndvi_emodis.csv", index=False)
```

```python
adm0_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_shp_adm0_clipped,
    admID1="ISO3",
    admID2="NOMPAY",
    type="emodis",
    data_dir=emodis_dir,
)
adm0_ndvi_df.to_csv(output_dir / "ner_adm0_clipped_ndvi_emodis.csv", index=False)
```

## Admin 1

```python
ner_shp_adm1.drop(
    ["OBJECTID", "Shape_Leng", "Shape_Area", "ISO3", "ISO2"], axis=1, inplace=True
)
```

### For areas not clipped

```python
adm1_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_shp_adm1,
    admID1="rowcacode1",
    admID2="NOMREG",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm1_ndvi_df.to_csv(output_dir / "ner_adm1_ndvi_eviirs.csv", index=False)
```

```python
adm1_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_shp_adm1,
    admID1="rowcacode1",
    admID2="NOMREG",
    type="emodis",
    data_dir=emodis_dir,
)
adm1_ndvi_df.to_csv(output_dir / "ner_adm1_ndvi_emodis.csv", index=False)
```

### For clipped areas

```python
adm1_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_shp_adm1_clipped,
    admID1="rowcacode1",
    admID2="NOMREG",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm1_ndvi_df.to_csv(output_dir / "ner_adm1_clipped_ndvi_eviirs.csv", index=False)
```

```python
adm1_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_shp_adm1_clipped,
    admID1="rowcacode1",
    admID2="NOMREG",
    type="emodis",
    data_dir=emodis_dir,
)
adm1_ndvi_df.to_csv(output_dir / "ner_adm1_clipped_ndvi_emodis.csv", index=False)
```

## Admin 2

```python
ner_shp_adm2.drop(
    ["OBJECTID", "Shape_Leng", "Shape_Area", "adm_01", "rowcacode1", "ISO3", "ISO2"],
    axis=1,
    inplace=True,
)
ner_shp_adm2
```

### For areas not clipped

```python
adm2_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_shp_adm2,
    admID1="rowcacode2",
    admID2="NOMDEP",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm2_ndvi_df.to_csv(output_dir / "ner_adm2_ndvi_eviirs.csv", index=False)
```

```python
adm2_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_shp_adm2,
    admID1="rowcacode2",
    admID2="NOMDEP",
    type="emodis",
    data_dir=emodis_dir,
)
adm2_ndvi_df.to_csv(output_dir / "ner_adm2_ndvi_emodis.csv", index=False)
```

### For clipped areas

```python
ner_adm2_clipped_geom = ner_shp_adm2_clipped[
    ner_shp_adm2_clipped["geometry"] != None
].reset_index(drop=True)
```

```python
adm2_ndvi_df = aggregating_admin(
    file_list=eviirs_file_list,
    geodf=ner_adm2_clipped_geom,
    admID1="rowcacode2",
    admID2="NOMDEP",
    type="eviirs",
    data_dir=eviirs_dir,
)
adm2_ndvi_df.to_csv(output_dir / "ner_adm2_clipped_ndvi_eviirs.csv", index=False)
```

```python
adm2_ndvi_df = aggregating_admin(
    file_list=emodis_file_list,
    geodf=ner_adm2_clipped_geom,
    admID1="rowcacode2",
    admID2="NOMDEP",
    type="emodis",
    data_dir=emodis_dir,
)
adm2_ndvi_df.to_csv(output_dir / "ner_adm2_clipped_ndvi_emodis.csv", index=False)
```
